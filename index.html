<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magetan AI</title>
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    header { background: #0066cc; color: white; padding:1rem; text-align:center; }
    .search { max-width:600px; margin:1rem auto; }
    .results .item { background:white; padding:15px; margin-bottom:10px; border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1); opacity:0; transform:translateY(20px);
      animation:fadeIn 0.4s forwards; }
    @keyframes fadeIn { to { opacity:1; transform:translateY(0);} }
    .chatbox { max-width:600px; margin:2rem auto; background:white; padding:1rem; border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .chat-log { height:200px; overflow-y:auto; margin-bottom:1rem; }
    .msg-user { text-align:right; color:#0066cc;margin:5px; }
    .msg-bot { text-align:left; color:#333;margin:5px; }
    input, button { padding:10px; font-size:1rem; }
    input { width: calc(100% - 110px); border:1px solid #ccc; border-radius:4px; }
    button { width:100px; margin-left:5px; background:#0066cc;color:white;border:none;cursor:pointer; }
  </style>
</head>
<body>
  <header data-aos="fade-down"><h1>Magetan.ai</h1><p>Tanya tentang UMKM & kegiatan Magetan</p></header>

  <div class="search">
    <input id="query" placeholder="Cari artikel..." oninput="searchItems()">
    <div class="results" id="results"></div>
  </div>

  <div class="chatbox">
    <div class="chat-log" id="chatLog">
      <div class="msg-bot"><strong>ü§ñ Bot:</strong> Halo! Tanyakan apa saja tentang Magetan.</div>
    </div>
    <div style="display:flex;">
      <input id="userMsg" placeholder="Ketik pertanyaan..." />
      <button onclick="askBot()">Kirim</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init();
    const API_KEY = "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";
    const URL = "https://usahamikrotambran.biz.id/";
    let items = [];

    async function fetchBlog() {
      const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(URL)}`);
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const posts = doc.querySelectorAll("article, .post, .entry");
      items = Array.from(posts).map(p => {
        return {
          title: p.querySelector("h1,h2,h3")?.innerText.trim() || 'Tanpa Judul',
          summary: p.querySelector("p")?.innerText.trim() || '',
          link: p.querySelector("a")?.href.startsWith(URL) ? p.querySelector("a").href : URL
        };
      });
    }

    function searchItems() {
      const q = document.getElementById("query").value.toLowerCase();
      const resEl = document.getElementById("results");
      resEl.innerHTML = "";
      items.filter(i => i.title.toLowerCase().includes(q) || i.summary.toLowerCase().includes(q))
        .forEach((i, idx) => {
          const d = document.createElement("div");
          d.className = "item";
          d.style.animationDelay = `${idx * 0.05}s`;
          d.innerHTML = `<h3>${i.title}</h3><p>${i.summary.slice(0,150)}‚Ä¶</p><a href="${i.link}" target="_blank">Baca selengkapnya</a>`;
          resEl.appendChild(d);
        });
    }

    async function askBot() {
      const q = document.getElementById("userMsg").value.trim();
      if(!q) return;
      appendMsg(q, "user");
      document.getElementById("userMsg").value = "";

      const texts = items.slice(0,5).map(i => `${i.title}: ${i.summary}`).join("\n");
      const prompt = `Artikel tentang Magetan:\n${texts}\n\nPertanyaan: ${q}`;

      let reply = "Maaf, saya tidak dapat menjawab.";
      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "Authorization":`Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model:"openai/gpt-3.5-turbo",
            messages:[
              { role:"system", content:"Anda adalah asisten AI ahli tentang UMKM di Magetan berdasarkan artikel." },
              { role:"user", content:prompt }
            ]
          })
        });
        const data = await res.json();
        reply = data.choices?.[0]?.message?.content.trim() || reply;
      } catch(err) {
        console.error(err);
      }
      appendMsg(reply, "bot");
    }

    function appendMsg(text, who){
      const div = document.createElement("div");
      div.className = who === "user" ? "msg-user" : "msg-bot";
      div.innerHTML = `<strong>${who==="user"?"üë©‚Äçüè´ Anda":"ü§ñ Bot"}:</strong> ${text}`;
      const cont = document.getElementById("chatLog");
      cont.appendChild(div);
      cont.scrollTop = cont.scrollHeight;
    }

    fetchBlog();
  </script>
</body>
</html>
